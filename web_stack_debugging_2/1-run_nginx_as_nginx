#!/usr/bin/env bash
# This script runs Nginx as the nginx user and ensures it listens on port 8080.

# Update Nginx configuration to run as the nginx user
sudo sed -i 's/user  root;/user  nginx;/' /etc/nginx/nginx.conf

# Update Nginx to listen on all IPs on port 8080
sudo sed -i 's/listen\s\+80;/listen 8080 default_server;/' /etc/nginx/sites-available/default

# Restart Nginx to apply the changes
sudo systemctl restart nginx

# Ensure Nginx is running as the nginx user
if pgrep -u nginx nginx > /dev/null; then
    echo "Nginx is running as the nginx user."
else
    echo "Failed to start Nginx as the nginx user."
    exit 1
fi

# Ensure Nginx is listening on port 8080
if nc -z 0 8080; then
    echo "Nginx is listening on port 8080."
else
    echo "Nginx is not listening on port 8080."
    exit 1
fi
